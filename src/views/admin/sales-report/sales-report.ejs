<%- include('../partials/head/head.ejs') %>

    <body>
        <div class="screen-overlay"></div>
        <main class="main-wrap">
            <%- include('../partials/header/header.ejs') %>
                <div class="container">
                    <div class="row mt-3 mb-5">
                        <h3>Sales Report - <%= period.charAt(0).toUpperCase() + period.slice(1) %>
                        </h3>
                        <div class="d-flex justify-content-end">
                            <strong>Total Amount: <h1>$<%= totalRevenue %>
                                </h1></strong>
                        </div>
                        <div>
                            <button onclick="history.back()">Go Back</button>
                        </div>
                    </div>

                    <div class="row mt-3 mb-4">
                        <form action="/admin/sales-report" method="get">
                            <div class="mb-3">
                                <label for="rangeSelect" class="form-label">Select Time Range:</label>
                                <select class="form-select" id="rangeSelect" name="period">
                                    <option value="daily" <%=period==='daily' ? 'selected' : '' %>>Daily</option>
                                    <option value="weekly" <%=period==='weekly' ? 'selected' : '' %>>Weekly</option>
                                    <option value="monthly" <%=period==='monthly' ? 'selected' : '' %>>Monthly</option>
                                    <option value="yearly" <%=period==='yearly' ? 'selected' : '' %>>Yearly</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Generate Report</button>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#customDate">Custom Date</button>
                        </form>
                    </div>

                    <% if (reportData.length===0) { %>
                        <div class="row">
                            <h1 style="background-color: rgba(214, 7, 7, 0.418);">SORRY NO ORDER FOUND BOOST YOUR SALE
                            </h1>
                        </div>
                        <% } else { %>
                            <table id="salesReportTable" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Number</th>
                                        <th>Username</th>
                                        <th>Product Name</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Coupon Discount</th>
                                        <th>Original Amount</th>
                                        <th>Total Revenue</th>
                                        <th>Total Discount Percentage</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% reportData.forEach((item, index)=> { %>
                                        <tr>
                                            <td>
                                                <%= index + 1 %>
                                            </td>
                                            <td>
                                                <%= item.username %>
                                            </td>
                                            <td>
                                                <%= item.productName %>
                                            </td>
                                            <td>
                                                <%= item.quantity %>
                                            </td>
                                            <td>$<%= item.price %>
                                            </td>
                                            <td>$<%= item.couponDiscount %>
                                            </td>
                                            <td>$<%= item.originalAmount %>
                                            </td>
                                            <td>$<%= item.totalRevenue %>
                                            </td>
                                            <td>
                                                <%= item.totalDiscountPercentage %> %
                                            </td>
                                        </tr>
                                        <% }) %>
                                </tbody>
                            </table>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button onclick="downloadReport(document.getElementById('rangeSelect').value)"
                                        class="btn btn-success">Download Report</button>
                                </div>
                            </div>
                            <% } %>
                </div>

                <!-- Modal for custom date range -->
                <div class="modal fade text-start" id="customDate" tabindex="-1" aria-labelledby="myModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="myModalLabel">Custom Date Report</h5>
                                <button class="btn-close btn-close-white" type="button" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form action="/admin/sales-report" method="get">
                                    <input type="hidden" name="period" value="custom">
                                    <div class="mb-3">
                                        <label class="form-label" for="start-date">Select Start Date</label>
                                        <input class="form-control" id="start-date" type="date" name="startDate"
                                            max="9999-12-31" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label" for="end-date">Select End Date</label>
                                        <input class="form-control" id="end-date" type="date" name="endDate"
                                            max="9999-12-31" required>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-secondary" type="button"
                                            data-bs-dismiss="modal">Close</button>
                                        <button class="btn btn-primary" type="submit">Generate Report</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
        </main>
        <%- include('../partials/footer/footer.ejs') %>

            <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

            <script>
                async function downloadReport(period) {
                    try {
                        const response = await axios.get(`/admin/download-report?period=${period}`, { responseType: 'blob' });

                        // Create a blob object from the response data
                        const blob = new Blob([response.data], { type: 'application/pdf' });

                        // Create a temporary URL for the blob object
                        const url = window.URL.createObjectURL(blob);

                        // Create a link element
                        const link = document.createElement('a');
                        link.href = url;
                        link.setAttribute('download', `sales_report_${period}.pdf`); // Set filename based on period

                        // Append the link to the document body and trigger the download
                        document.body.appendChild(link);
                        link.click();

                        // Cleanup
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    } catch (error) {
                        console.log('Error downloading report:', error);
                    }
                }

                window.addEventListener('DOMContentLoaded', function () {
                    const today = new Date();
                    const dd = String(today.getDate()).padStart(2, '0');
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const yyyy = today.getFullYear();
                    const maxDate = `${yyyy}-${mm}-${dd}`;

                    document.getElementById('start-date').max = maxDate;
                    document.getElementById('end-date').max = maxDate;

                    document.getElementById('end-date').addEventListener('input', function () {
                        const endDateInput = document.getElementById('end-date');
                        if (endDateInput.value > maxDate) {
                            endDateInput.value = maxDate;
                        }
                    });
                });
            </script>
    </body>