<!DOCTYPE html>
<html lang="en">

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    th,
    td {
        padding: 12px;
        border: 1px solid #dddddd;
        text-align: left;
    }

    th {
        background-color: #f2f2f2;
    }

    .order-details-body td {
        text-align: center;
    }

    .checkout-details td {
        text-align: right;
    }

    .checkout-details tr:first-child td {
        border-top: 2px solid #000;
    }

    .total-row td {
        font-weight: bold;
    }

    h6 {
        margin: 0;
    }

    @media screen and (max-width: 600px) {

        table,
        thead,
        tbody,
        th,
        td,
        tr {
            display: block;
        }

        tr {
            margin-bottom: 15px;
        }

        td {
            text-align: right;
            padding-left: 50%;
            position: relative;
        }

        td:before {
            content: attr(data-label);
            position: absolute;
            left: 0;
            padding-left: 10px;
            text-align: left;
            font-weight: bold;
        }
    }
</style>

<%- include('./partials/head/head.ejs') %>

    <body>
        <%- include('./partials/header/header.ejs') %>

            <!-- breadcrumb-section -->
            <div class="breadcrumb-section breadcrumb-bg">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-8 offset-lg-2 text-center">
                            <div class="breadcrumb-text">
                                <p>Fresh and Organic</p>
                                <h1>Check Out Product</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end breadcrumb section -->

            <div class="container mt-5">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="checkout-accordion">
                            <div class="accordion" id="accordionExample">
                                <div class="card single-accordion">
                                    <div class="card-header" id="headingOne">
                                        <h5 class="mb-0">
                                            <button class="btn btn-link" type="button" data-toggle="collapse"
                                                data-target="#collapseAddress" aria-expanded="true"
                                                aria-controls="collapseAddress">
                                                My Address
                                            </button>
                                            <a class="pl-4" href="/address">Change Address</a>
                                        </h5>
                                    </div>
                                    <div id="collapseAddress" class="collapse show" aria-labelledby="headingOne"
                                        data-parent="#accordionExample">
                                        <div class="card-body">
                                            <% if(defaultAddress){ %>
                                                <form id="addressForm">
                                                    <label>
                                                        <input type="radio" name="selectedAddress"
                                                            value="<%= defaultAddress._id %>" checked>
                                                        <span class="p-2">Name: <%= defaultAddress.name.toUpperCase() %>
                                                        </span><br>
                                                        <span class="p-2">Phone No.: <%= defaultAddress.phoneNumber %>
                                                        </span><br>
                                                        <span class="p-2">Home Address: <%= defaultAddress.homeAddress
                                                                %></span><br>
                                                        <span class="p-2">State: <%= defaultAddress.state %></span>
                                                    </label>
                                                </form>
                                                <% } else { %>
                                                    <h4>No address Found</h4>
                                                    <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="checkout-accordion-wrap mt-5">
                            <div class="accordion" id="accordionExample">
                                <div class="card single-accordion">
                                    <div class="card-header" id="headingTwo">
                                        <h5 class="mb-0">
                                            <button class="btn btn-link" type="button" data-toggle="collapse"
                                                data-target="#collapseBilling" aria-expanded="true"
                                                aria-controls="collapseBilling">
                                                Add New Address
                                            </button>
                                        </h5>
                                    </div>
                                    <div id="collapseBilling" class="collapse show" aria-labelledby="headingTwo"
                                        data-parent="#accordionExample">
                                        <div class="card-body">
                                            <div class="billing-address-form">
                                                <form action="/add-address" method="post">
                                                    <input type="text" name="path" value="checkout" hidden>
                                                    <div class="form-group">
                                                        <input type="text" name="name" class="form-control"
                                                            placeholder="Name" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <input type="tel" name="phoneNumber" class="form-control"
                                                            placeholder="Phone" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <input type="text" name="homeAddress" class="form-control"
                                                            placeholder="Home Address" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <input type="text" name="city" class="form-control"
                                                            placeholder="City" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <input type="text" name="country" class="form-control"
                                                            placeholder="Country" required>
                                                    </div>
                                                    <div class="form-group">
                                                        <textarea name="bill" id="bill" class="form-control" cols="30"
                                                            rows="4" placeholder="Say Something"></textarea>
                                                    </div>
                                                    <button class="btn btn-dark" type="submit">ADD</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="order-details-wrap">
                            <table class="order-details">
                                <thead>
                                    <tr>
                                        <th colspan="3">Your Order Details</th>
                                    </tr>
                                    <tr>
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody class="order-details-body">
                                    <% cartDatas.items.forEach(product=> { %>
                                        <tr>
                                            <td data-label="Product">
                                                <%= product.productId.name %>
                                            </td>
                                            <td data-label="Quantity">
                                                <%= product.quantity %>
                                            </td>
                                            <td data-label="Total">₹<%= product.productId.discount_price.toFixed(2) %>
                                            </td>
                                        </tr>
                                        <% }) %>
                                </tbody>
                                <tbody class="checkout-details">
                                    <tr>
                                        <td colspan="2">Shipping</td>
                                        <td>₹50.00</td>
                                    </tr>
                                    <% if (cartDatas.couponDiscount) { %>
                                        <tr class="total-row">
                                            <td colspan="2">Coupon Discount</td>
                                            <td><span id="couponDiscount">
                                                    <%= cartDatas.couponDiscount %>
                                                </span> %
                                                <button name="" style="width: 6rem;height: auto;font-weight: bolder;"
                                                onclick="removeCoupon()" id="" class="btn btn-danger">Remove</button></td>                                                
                                        </tr>
                                        <% }else {%>
                                            <span id="couponDiscount" hidden></span>
                                            <% } %>

                                                <tr class="total-row">
                                                    <td colspan="2">Total</td>
                                                    <% if (cartDatas.couponDiscount) { %>
                                                        <td>
                                                            <h6>Coupon Applied</h6>
                                                            <del>₹<%= totalPrice.toFixed(2) %></del>
                                                            ₹ <span id="totalPrice">
                                                                <%= cartDatas.totalPrice.toFixed(2) %>
                                                            </span>
                                                           
                                                        </td>
                                                        <% } else { %>
                                                            <td>₹<span id="totalPrice">
                                                                    <%= cartDatas.totalPrice.toFixed(2) %>
                                                                </span></td>
                                                            <% } %>
                                                </tr>
                                </tbody>
                            </table>
                            <% if (!cartDatas.couponDiscount) { %>
                                <div class="coupon-section">
                                    <h4>Apply Coupon</h4>
                                    <div class="coupon-form-wrap">
                                        <p><input type="text" placeholder="Coupon" id="couponCode" required>
                                            <input value="Apply" type="submit" onclick="applyCoupon()">
                                        </p>
                                    </div>
                                </div>
                                <% } %>
                                    <div class="container mt-5 mb-5">
                                        <div class="card">
                                            <div class="card-body">
                                                <h3 class="card-title">Select Payment Method</h3>
                                                <div class="mt-4">
                                                    <button id="pay-button" class="btn btn-primary btn-block">Pay with
                                                        Razorpay</button>
                                                </div>
                                                <div class="mt-3">
                                                    <button onclick="proceedToPayment()"
                                                        class="btn btn-secondary btn-block">Pay with Cash
                                                        on Delivery</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                        </div>
                    </div>
                </div>
            </div>
            <br><br>

            <%- include('./partials/footer/footer.ejs') %>

                <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

                <script>
                    async function removeCoupon() {
                        const totalPrice = document.getElementById('totalPrice').innerHTML
                        const couponDiscount = document.getElementById('couponDiscount').innerHTML
                        await fetch(`/remove-coupon/?totalPrice=${totalPrice}&couponDiscount=${couponDiscount}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        }).then(response => {
                            if (!response.ok) {
                                throw new Error('Some error occured while removing the coupon using fetch')
                            }
                            return response.json()
                        }).then(data => {
                            if (data.result === 'success') {
                                Swal.fire('coupon removed successfully').then(()=>{
                                    location.reload()
                                })
                            } else {
                                Swal.fire('Some issue encountered')
                            }
                        }).catch(err => {
                            console.log(err, 'Some error occured while try to remove coupon in checkout page');
                        })
                    }
                </script>
                <script>
                    async function applyCoupon() {
                        const couponCode = document.getElementById('couponCode').value
                        const couponDiscount = document.getElementById('couponDiscount').innerHTML
                        console.log(couponCode, 'coupon code is showing');
                        console.log(couponDiscount, 'coupon discount is showing');
                        if (couponCode && !couponDiscount) {
                            const totalCartPriceData = document.getElementById('totalPrice')
                            const totalCartPrice = Number(totalCartPriceData.innerHTML)
                            console.log(totalCartPrice, 'totalcart price is showing');
                            const response = await fetch(`/apply-coupon/?couponCode=${couponCode}&totalCartPrice=${totalCartPrice}`, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Some error occured while fetching')
                                    }
                                    return response.json()
                                })
                                .then(data => {
                                    if (data.result === 'Invalid Coupon') {
                                        Swal.fire('Invalid Coupon')
                                    }
                                    else if (data.result === 'Cart Limit Is Low') {
                                        Swal.fire('Minimum cart price to apply coupon is 1000')
                                    } else if (data.result === 'Coupon Applied') {
                                        Swal.fire('Coupon Applied Successfully').then(() => {
                                            location.reload()
                                        })
                                        const discount = Number(data.discount)
                                        console.log(discount, 'discount is showing');
                                        totalCartPriceData.innerHTML = totalCartPrice - (totalCartPrice * (discount / 100))


                                    } else if (data.result === 'Coupon Already Exist') {
                                        Swal.fire('Coupon already used please apply another coupon')

                                    }
                                })
                        } else if (couponDiscount) {
                            Swal.fire('Coupon is already applied')
                        } else {
                            Swal.fire('Enter a coupon')
                        }

                    }
                </script>
                <script>
                    document.getElementById('pay-button').addEventListener('click', async function (e) {
                        e.preventDefault();
                        const amount = document.getElementById('totalPrice').innerHTML;
                        console.log(amount, 'amount is showing');
                        const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked').value;
                        const couponDiscount = document.getElementById('couponDiscount').innerHTML
                        console.log(couponDiscount, 'coupon discount is showing');
                        console.log(selectedAddress, 'selectedAddress is showing')
                        try {
                            console.log('razorpay is working');
                            const response = await fetch(`/razorpay-payment`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ amount: amount.trim() })
                            });

                            if (!response.ok) {
                                throw new Error('Failed to create order');
                            }

                            const order = await response.json();
                            console.log(order, 'order is showing');
                            const options = {
                                key: 'rzp_test_e55Dk1oHQbvyBo',
                                amount: order.amount,
                                currency: order.currency,
                                order_id: order.id,
                                name: 'Your Company Name',
                                description: 'Test Payment',
                                image: 'https://via.placeholder.com/150',
                                handler: function (response) {
                                    Swal.fire({
                                        text: 'Payment Successful! Payment ID: ' + response.razorpay_payment_id,
                                        icon: 'success'
                                    }).then(() => {
                                        razorpaySuccess(response.razorpay_payment_id);
                                    });
                                },
                                prefill: {
                                    name: 'John Doe',
                                    email: 'john.doe@example.com',
                                    contact: '1234567890'
                                },
                                theme: {
                                    color: '#528FF0'
                                }
                            };

                            const razorpayInstance = new Razorpay(options);
                            razorpayInstance.open();

                            async function razorpaySuccess(paymentId) {
                                const paymentMethod = 'Online Payment';
                                await fetch(`/order-add/?paymentMethod=${paymentMethod}&paymentId=${paymentId}&address=${selectedAddress}&couponDiscount=${couponDiscount}`, {
                                    method: 'GET',
                                    headers: { 'Content-Type': 'application/json' }
                                }).then(response => response.ok ? response.json() : console.log('Network error'))
                                    .then((data) => {
                                        if (data.result === 'success')
                                            window.location.href = '/order-placed';
                                    }).catch(err => {
                                        console.log('Error:', err);
                                    });
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('Failed to create order');
                        }
                    });

                    function proceedToPayment() {
                        orderPlace();
                    }

                    async function orderPlace() {
                        const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked').value;
                        const couponDiscount = document.getElementById('couponDiscount').innerHTML

                        const paymentMethod = 'cash on delivery'
                        await fetch(`/order-add/?paymentMethod=${paymentMethod}&address=${selectedAddress}&couponDiscount=${couponDiscount}`, {
                            method: 'GET',
                            headers: { 'Content-Type': 'application/json' }
                        }).then(response => response.ok ? response.json() : console.log('Network error'))
                            .then((data) => {
                                if (data.result === 'success')
                                    window.location.href = '/order-placed';
                            }).catch(err => {
                                console.log('Error:', err);
                            });
                    }
                </script>
    </body>

</html>