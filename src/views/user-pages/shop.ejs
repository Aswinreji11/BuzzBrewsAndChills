<!DOCTYPE html>
<html lang="en">
    <style>
        .sort-options {
            display: flex;
            align-items: center;
            font-size: 1.1em;
        }

        .sort-options label {
            margin-right: 10px;
        }

        .custom-select {
            padding: 5px 10px;
            font-size: 1em;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .single-product-item {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 10px;
            background-color: #fff;
            transition: box-shadow 0.3s;
        }

        .single-product-item:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .product-image img {
            max-width: 100%;
            border-radius: 10px;
        }

        .product-price del {
            color: #999;
            margin-right: 5px;
        }

        .cart-btn {
            background-color: #28a745;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .cart-btn:hover {
            background-color: #218838;
        }

        .cart-btn[disabled] {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .pagination-wrap ul {
            display: flex;
            list-style: none;
            padding: 0;
        }

        .pagination-wrap ul li {
            margin: 0 5px;
        }

        .pagination-wrap ul li a {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-decoration: none;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }

        .pagination-wrap ul li a:hover,
        .pagination-wrap ul li a.active {
            background-color: #28a745;
            color: #fff;
        }
    </style>

<%- include ('./partials/head/head.ejs' ) %>

    <body>

        <%- include('./partials/header/header.ejs') %>

            <!-- breadcrumb-section -->
            <div class="breadcrumb-section breadcrumb-bg">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-8 offset-lg-2 text-center">
                            <div class="breadcrumb-text">
                                <p>Fresh and Organic</p>
                                <h1>Shop</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end breadcrumb section -->

            <!-- products -->
            <div class="product-section mt-150 mb-150">
                <div class="container">

                    <div class="row">
                        <div class="col-md-12">
                            <div class="product-filters">
                                <ul>
                                    <li class="active" data-filter="*" onclick="filterProducts('*')">All</li>
                                    <li data-filter=".energy" onclick="filterProducts('energy')">ENERGY DRINKS</li>
                                    <li data-filter=".cool" onclick="filterProducts('cool')">COOL DRINKS</li>
                                    <li data-filter=".coffee" onclick="filterProducts('coffee')">COLD COFFEE</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-12 d-flex justify-content-end">
                            <div class="sort-options">
                                <label for="sortSelect" class="mr-2">Sort by:</label>
                                <select id="sortSelect" class="custom-select" onchange="sortProducts()">
                                    <option value="default">Default</option>
                                    <option value="priceLowHigh">Price: Low to High</option>
                                    <option value="priceHighLow">Price: High to Low</option>
                                    <option value="popularity">Popularity</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row product-lists">
                        <% console.log(products.length); %> 
                        <% if(products){console.log(products.length)} %>
                            <% for(let i=0; i<products.length;i++){%>
                                <div class="col-lg-4 col-md-6 text-center berry">
                                    <div class="single-product-item">
                                        <a href="/product-view/<%= products[i]._id %> ">
                                            <div class="product-image">
                                                <img src="/product-images/<%= products[i].imageUrl[0] %>"
                                                    alt="<%= products[i].name %>">
                                            </div>
                                        </a>
                                        <h3>
                                            <%= products[i].name %>
                                        </h3>
                                        <% if (products[i].stock <40) { %>
                                            <% if (products[i].stock===0) { %>
                                                <p style="font-weight: bold;font-size: medium;" class="text-danger">
                                                    Product is currently <br>
                                                    out of stock!!!</p>
                                                <% }else{ %>
                                                    <p class="product-stock">
                                                        <span class="text-danger"
                                                            style="font-weight: bolder;font-size: medium;">Hot
                                                            Deal!</span><br>
                                                        <span class="text-success"
                                                            style="font-size: medium;font-weight: bold;">In
                                                            Stock </span>,only <span id="stock_<%= i %>">
                                                            <%= products[i].stock %>
                                                        </span> left
                                                    </p>
                                                    <% } %>
                                                        <% } %>
                                                        <% console.log(products[i].discount_price,'what is showing here'); %> 
                                                        <% if (products[i].discount_price === products[i].price) { %>
                                                            <p class="product-price">
                                                                <span>Per Kg</span>Rs
                                                                <%= products[i].price %>
                                                            </p>
                                                            
                                                        <% }else{ %>
                                                            <p class="product-price">
                                                                <span>Per Kg</span>Rs
                                                                <del><%= products[i].price %></del> <%= products[i].discount_price %> 

                                                            </p>
                                                            <% } %> 
                                                            <% if (products[i].stock> 0){ %>

                                                                <button
                                                                    onclick="addToCartUsingFetch('<%= i %>',`<%= products[i]._id %>`)"
                                                                    class="cart-btn"><i
                                                                        class="fas fa-shopping-cart"></i> Add to
                                                                    Cart</button>
                                                                <% }else{ %>
                                                                    <button class="cart-btn" disabled>
                                                                        <i class="fas fa-shopping-cart"></i>
                                                                        Add to Cart</button>
                                                                    </button>
                                                                    <% } %>
                                    </div>case 'topBrand':
                                    productsArray.sort((a, b) => a.getAttribute('data-branch').localeCompare(b.getAttribute('data-branch')));
                                    break;
                                </div>
                                <% }%>
                    </div>

                    <div class="row">
                        <div class="col-lg-12 text-center">
                            <div class="pagination-wrap">
                                <ul>
                                    <li><a href="#">Prev</a></li>
                                    <li><a href="#">1</a></li>
                                    <li><a class="active" href="#">2</a></li>
                                    <li><a href="#">3</a></li>
                                    <li><a href="#">Next</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end products -->

            <%- include('./partials/footer/footer.ejs') %>

                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    </body>

    <script>
        const productsPerPage = 6;
        let currentPage = 1;
        let filteredProducts = document.querySelectorAll('.product-item');
        console.log(filterProducts,'filtered product is showing');
        function displayProducts(page) {
            const start = (page - 1) * productsPerPage;
            const end = start + productsPerPage;
    
            filteredProducts.forEach((product, index) => {
                product.style.display = (index >= start && index < end) ? 'block' : 'none';
            });
    
            updatePagination();
        }
    
        function changePage(direction) {
            const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
            currentPage = Math.max(1, Math.min(totalPages, currentPage + direction));
            displayProducts(currentPage);
        }
    
        function updatePagination() {
            const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '<li><a href="javascript:void(0);" onclick="changePage(-1)">Prev</a></li>';
    
            for (let i = 1; i <= totalPages; i++) {
                pagination.innerHTML += `<li><a href="javascript:void(0);" class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</a></li>`;
            }
    
            pagination.innerHTML += '<li><a href="javascript:void(0);" onclick="changePage(1)">Next</a></li>';
        }
    
        function goToPage(page) {
            currentPage = page;
            displayProducts(page);
        }
    
        function filterProducts(category) {
            filteredProducts = document.querySelectorAll(`.product-item[data-category="${category}"], .product-item[data-category="*"]`);
            currentPage = 1;
            displayProducts(currentPage);
        }
    
        async function sortProducts() {
            const sortOption = document.getElementById('sortSelect').value;
            
            await fetch(`/shop/?sortOption=${sortOption}`,{
                method:'GET',
                headers:{
                    'Content-Type':'application/json'
                }
            }).then((response)=>{
                if(!response.ok){
                    throw new Error('some error while fetching the data')
                }
            }).then((data)=>{
                if(data.result=='success'){
                    console.log('successfully fetched the data');
                }
            }).catch(err=>console.log('some error in the controller'))


            const productContainer = document.getElementById('productContainer');
            console.log(productContainer,'what is this');
            const productsArray = Array.from(filteredProducts);
            console.log(productsArray,'product array is showing');
            console.log(sortOption,'sort option is showing');
            switch (sortOption) {
                case 'priceLowHigh':
                    productsArray.sort((a, b) => parseFloat(a.getAttribute('data-discount-price')) - parseFloat(b.getAttribute('data-discount-price')));
                    break;
                case 'priceHighLow':
                    productsArray.sort((a, b) => parseFloat(b.getAttribute('data-discount-price')) - parseFloat(a.getAttribute('data-discount-price')));
                    break;
                case 'popularity':
                    productsArray.sort((a, b) => parseFloat(b.getAttribute('data-popularity')) - parseFloat(a.getAttribute('data-popularity')));
                    break;
                default:
                    break;
            }
    
            productsArray.forEach(product => productContainer.appendChild(product));
            displayProducts(currentPage);
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            displayProducts(currentPage);
        });
    </script>

    <script>
        async function addToCartUsingFetch(index, productId) {
            const productStock = document.getElementById('stock_' + index).innerHTML
            console.log(productStock, 'productstock is showing');
            await fetch(`/add-to-cart/?productId=${productId}&stock=${productStock}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'applicaton/json'
                }
            }) .then((response) => {
           if (response.redirected) {
            Swal.fire({
            title: "Invalid Entry",
            text: "Please sign in to continue.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Sign In",
            cancelButtonText: "Cancel"
            }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '/signin'
               }
            })
          } else if (!response.ok) {
                throw new Error('A network error occurred while fetching data.')
              }
               return response.json()
           })

                .then(data => {
                    console.log(data.result)
                    data.result === 'within limit' ?
                        Swal.fire({
                            position: "center",
                            icon: "success",
                            title: "Successfully product added to cart",
                            showConfirmButton: false,
                            timer: 1500
                        }) : Swal.fire({
                            position: "center",
                            icon: "error",
                            title: "Maximum product limit is exceeded",
                            showConfirmButton: false,
                            timer: 1500
                        })
                }).catch(err => {
                    console.log(err, 'Some error occured in fetch method in shop page');
                })
        }
    </script>

</html>